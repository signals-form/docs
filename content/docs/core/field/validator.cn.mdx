---
title: æ ¡éªŒå™¨
description: çµæ´»å¼ºå¤§çš„è¡¨å•å­—æ®µæ ¡éªŒç³»ç»Ÿ
---

## æ¦‚è¿°

åœ¨å¤æ‚è¡¨å•åœºæ™¯ä¸­ï¼Œæ ¡éªŒç³»ç»Ÿéœ€è¦è€ƒè™‘å¤šä¸ªç»´åº¦ï¼šæ ¡éªŒè§„åˆ™ã€æ ¡éªŒæ—¶æœºã€æ ¡éªŒç»“æœå¤„ç†ã€æ ¡éªŒé€»è¾‘ç»„åˆã€æ ¡éªŒä¸Šä¸‹æ–‡ã€æ ¡éªŒæµç¨‹æ§åˆ¶ç­‰ã€‚SignalForm æä¾›äº†å®Œæ•´çš„æ ¡éªŒå™¨è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡ `defineValidator` æ¥å®šä¹‰çµæ´»çš„æ ¡éªŒå™¨ã€‚

## æ ¡éªŒæ¨¡å¼

SignalForm æ”¯æŒä¸¤ç§æ ¡éªŒæ¨¡å¼ï¼š

### ä¸»åŠ¨å¼æ ¡éªŒ (Initiative)
ç”¨æˆ·ä¸»åŠ¨è§¦å‘å­—æ®µå€¼å˜æ›´æ—¶è§¦å‘çš„æ ¡éªŒï¼Œé€‚ç”¨äºå®æ—¶åé¦ˆåœºæ™¯ã€‚

### è¢«åŠ¨å¼æ ¡éªŒ (Passive)  
å½“ä¾èµ–çš„å…¶ä»–å­—æ®µå‘ç”Ÿå˜åŒ–æ—¶è§¦å‘çš„æ ¡éªŒï¼Œé€‚ç”¨äºå­—æ®µé—´å…³è”æ ¡éªŒã€‚

```ts
const password = defineField({
  id: "password",
  component: Input,
  props: { 
    label: "å¯†ç ", 
    type: "password", 
    prefix: "ğŸ”’", 
    required: true 
  },
  validators: [
    // ä¸»åŠ¨å¼æ ¡éªŒ - ç”¨æˆ·è¾“å…¥æ—¶è§¦å‘
    defineValidator()
      .initiative()
      .schema(z.string({ message: "è¯·è¾“å…¥å¯†ç ï¼" })
        .min(6, "å¯†ç è‡³å°‘6ä½")
        .max(20, "å¯†ç ä¸èƒ½è¶…è¿‡20ä½")),
        
    // è¢«åŠ¨å¼æ ¡éªŒ - ä¾èµ–å…¶ä»–å­—æ®µå˜åŒ–è§¦å‘  
    defineValidator()
      .passive()
      .schema(z.string({ message: "è¯·è¾“å…¥å¯†ç ï¼" })
        .min(6, "å¯†ç è‡³å°‘6ä½")
        .max(20, "å¯†ç ä¸èƒ½è¶…è¿‡20ä½"))
  ]
})
```

> ğŸ’¡ **æç¤º**ï¼šä¸æŒ‡å®šæ¨¡å¼æ—¶ï¼Œé»˜è®¤ä¸ºä¸»åŠ¨å¼æ ¡éªŒã€‚åç»­ç¤ºä¾‹ä¸»è¦æ¼”ç¤ºä¸»åŠ¨å¼æ ¡éªŒï¼Œä¸¤ç§æ¨¡å¼çš„ API å®Œå…¨ä¸€è‡´ã€‚

## æ ¡éªŒè§„åˆ™å®šä¹‰

### åŸºç¡€ç”¨æ³•

SignalForm æ²¡æœ‰å†…ç½®é€šç”¨æ ¡éªŒè§„åˆ™ï¼Œè€Œæ˜¯æä¾›äº†çµæ´»çš„æ ¡éªŒå™¨èŒƒå¼ï¼Œè®©ä½ å¯ä»¥è½»æ¾é›†æˆå„ç§æ ¡éªŒå¼•æ“ã€‚ä»¥ Zod ä¸ºä¾‹ï¼š

```ts
// å•ä¸ªæ ¡éªŒå™¨
defineField({
  id: "username",
  component: Input,
  validators: defineValidator()
    .schema(z.string({ message: "è¯·è¾“å…¥ç”¨æˆ·åï¼" })
      .min(3, "ç”¨æˆ·åè‡³å°‘3ä½")
      .max(20, "ç”¨æˆ·åä¸èƒ½è¶…è¿‡20ä½"))
})

// å¤šä¸ªæ ¡éªŒå™¨
defineField({
  id: "email", 
  component: Input,
  validators: [
    defineValidator()
      .schema(z.string({ message: "è¯·è¾“å…¥é‚®ç®±ï¼" })
        .email("è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±æ ¼å¼"))
  ]
})
```

### ç®€åŒ–è¯­æ³•

å½“åªæœ‰ä¸€ä¸ªæ ¡éªŒå™¨ä¸”æ— å…¶ä»–é…ç½®æ—¶ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ schemaï¼š

```ts
defineField({
  id: "phone",
  component: Input,
  validators: z.string({ message: "è¯·è¾“å…¥æ‰‹æœºå·ï¼" })
    .regex(/^1[3-9]\d{9}$/, "è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·")
})
```

## æ ¡éªŒæ—¶æœºæ§åˆ¶

### updateOn - äº‹ä»¶è§¦å‘æ§åˆ¶

ç²¾ç¡®æ§åˆ¶æ ¡éªŒå™¨åœ¨å“ªäº›äº‹ä»¶è§¦å‘æ—¶æ‰§è¡Œï¼š

```ts
defineField({
  id: "password",
  component: Input,
  validators: [
    // è¾“å…¥æ—¶è¿›è¡Œæ ¼å¼æ ¡éªŒ
    defineValidator()
      .schema(z.string()
        .min(6, "å¯†ç è‡³å°‘6ä½")
        .regex(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/, "å¯†ç éœ€åŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—"))
      .updateOn(['onChange'])
      .type('warning'),
      
    // å¤±ç„¦æ—¶è¿›è¡Œå®Œæ•´æ€§æ ¡éªŒ
    defineValidator()
      .schema(z.string({ message: "å¯†ç ä¸èƒ½ä¸ºç©º" }))
      .updateOn(['onBlur'])  
      .type('error')
  ]
})
```

### should - æ¡ä»¶æ‰§è¡Œ

é€šè¿‡å†³ç­–å‡½æ•°æ§åˆ¶æ ¡éªŒå™¨æ˜¯å¦æ‰§è¡Œï¼š

```ts
defineField({
  id: "confirmPassword",
  component: Input,
  validators: defineValidator()
    .schema(z.string())
    .should((ctx) => {
      // ä»…å½“åŸå¯†ç å·²è¾“å…¥æ—¶æ‰æ ¡éªŒç¡®è®¤å¯†ç 
      const password = ctx.query('password')?.value
      return Boolean(password)
    })
    .fact((value, query) => ({
      password: query('password')?.value,
      confirmPassword: value
    }))
    .custom((ctx) => {
      if (ctx.value.password !== ctx.value.confirmPassword) {
        return {
          message: "ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´",
          type: "error"
        }
      }
    })
})
```

> ğŸ“ **è¯´æ˜**ï¼š`updateOn` ä¸å­˜åœ¨æ—¶ï¼Œé»˜è®¤ä¸º `onChange` äº‹ä»¶è§¦å‘æ ¡éªŒã€‚

## æ ¡éªŒç»“æœç±»å‹

### æ¶ˆæ¯ç±»å‹å®šä¹‰

é€šè¿‡ `type` æ–¹æ³•å®šä¹‰æ ¡éªŒåé¦ˆçš„æ¶ˆæ¯ç±»å‹ï¼š

```ts
defineField({
  id: "username",
  component: Input,
  validators: [
    // é”™è¯¯çº§åˆ« - é˜»æ­¢è¡¨å•æäº¤
    defineValidator()
      .schema(z.string({ message: "ç”¨æˆ·åä¸èƒ½ä¸ºç©º" }))
      .type('error'),
      
    // è­¦å‘Šçº§åˆ« - ä¸é˜»æ­¢æäº¤ä½†ç»™å‡ºæç¤º  
    defineValidator()
      .schema(z.string().min(8, "å»ºè®®ç”¨æˆ·åè‡³å°‘8ä½ä»¥æé«˜å®‰å…¨æ€§"))
      .type('warning'),
      
    // ä¿¡æ¯çº§åˆ« - å‹å¥½æç¤º
    defineValidator()
      .schema(z.string().max(20))
      .type('info')
      .custom((ctx) => ({
        message: `è¿˜å¯ä»¥è¾“å…¥ ${20 - ctx.value.length} ä¸ªå­—ç¬¦`,
        type: 'info'
      }))
  ]
})
```

## æ ¡éªŒå™¨ç»„åˆ

### å¤šæ ¡éªŒå™¨ç­–ç•¥

ä½¿ç”¨æ•°ç»„æ–¹å¼æ³¨å†Œå¤šä¸ªæ ¡éªŒå™¨ï¼Œåº”å¯¹ä¸åŒåœºæ™¯ï¼š

```ts
defineField({
  id: "email",
  component: Input,
  validators: [
    // å¿…å¡«æ ¡éªŒ
    defineValidator()
      .schema(z.string({ message: "é‚®ç®±ä¸èƒ½ä¸ºç©º" }))
      .updateOn(['onBlur'])
      .type('error'),
      
    // æ ¼å¼æ ¡éªŒ  
    defineValidator()
      .schema(z.string().email("è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±æ ¼å¼"))
      .updateOn(['onChange'])
      .type('warning'),
      
    // å¼‚æ­¥å”¯ä¸€æ€§æ ¡éªŒ
    defineValidator()
      .updateOn(['onBlur'])
      .debounce(500)
      .custom(async (ctx, abortSignal) => {
        const isUnique = await checkEmailUnique(ctx.value, { signal: abortSignal })
        if (!isUnique) {
          return {
            message: "è¯¥é‚®ç®±å·²è¢«æ³¨å†Œ",
            type: "error"
          }
        }
      })
  ]
})
```

## æ ¡éªŒä¸Šä¸‹æ–‡

### fact - æ•°æ®é¢„å¤„ç†

æ„é€ æ ¡éªŒæ‰€éœ€çš„æ•°æ®ç»“æ„ï¼Œæ”¯æŒè·¨å­—æ®µæ ¡éªŒï¼š

```ts
defineField({
  id: "endDate",
  component: DatePicker,
  validators: defineValidator()
    .schema(z.object({
      startDate: z.date(),
      endDate: z.date(),
    }))
    .fact((value, query) => ({
      startDate: query('startDate')?.value,
      endDate: value
    }))
    .custom((ctx) => {
      const { startDate, endDate } = ctx.value
      if (startDate && endDate && endDate <= startDate) {
        return {
          message: "ç»“æŸæ—¥æœŸå¿…é¡»æ™šäºå¼€å§‹æ—¥æœŸ",
          type: "error"
        }
      }
    })
})
```

### å¤æ‚ä¸šåŠ¡æ ¡éªŒ

```ts title="ç”¨æˆ·æ³¨å†Œæ ¡éªŒç¤ºä¾‹"
defineField({
  id: "username", 
  component: Input,
  validators: defineValidator()
    .fact((value, query, execDecision) => {
      const userType = query('userType')?.value
      const permissions = execDecision(D.use('userPermissions'))
      
      return {
        username: value,
        userType,
        permissions,
        minLength: userType === 'admin' ? 6 : 3
      }
    })
    .custom((ctx) => {
      const { username, userType, permissions, minLength } = ctx.value
      
      if (username.length < minLength) {
        return {
          message: `${userType === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'}ç”¨æˆ·åè‡³å°‘${minLength}ä½`,
          type: 'error'
        }
      }
      
      if (userType === 'admin' && !permissions.canCreateAdmin) {
        return {
          message: "æ‚¨æ— æƒåˆ›å»ºç®¡ç†å‘˜è´¦æˆ·",
          type: 'error'
        }
      }
    })
})
```

## æ ¡éªŒæµç¨‹æ§åˆ¶

### break - é˜»æ–­åç»­æ ¡éªŒ

æ§åˆ¶æ ¡éªŒå¤±è´¥æ—¶æ˜¯å¦ç»§ç»­æ‰§è¡Œåç»­æ ¡éªŒå™¨ï¼š

```ts
defineField({
  id: "password",
  component: Input,
  validators: [
    // å¿…å¡«æ ¡éªŒ - å¤±è´¥æ—¶é˜»æ–­åç»­æ ¡éªŒ
    defineValidator()
      .schema(z.string({ message: "å¯†ç ä¸èƒ½ä¸ºç©º" }))
      .type('error')
      .break(true), // error ç±»å‹é»˜è®¤ä¸º true
      
    // é•¿åº¦æ ¡éªŒ - å¤±è´¥æ—¶ä¸é˜»æ–­
    defineValidator()
      .schema(z.string().min(8, "å¯†ç å»ºè®®è‡³å°‘8ä½"))
      .type('warning') 
      .break(false), // warning ç±»å‹é»˜è®¤ä¸º false
      
    // å¤æ‚åº¦æ ¡éªŒ - åªæœ‰å‰é¢éƒ½é€šè¿‡æ‰æ‰§è¡Œ
    defineValidator()
      .schema(z.string().regex(
        /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])/,
        "å¯†ç éœ€åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦"
      ))
      .type('info')
  ]
})
```

## æ ¡éªŒå¼•æ“

### å¤šå¼•æ“æ”¯æŒ

åœ¨å¤§å‹è¡¨å•ç³»ç»Ÿä¸­æ”¯æŒå¤šç§æ ¡éªŒå¼•æ“ï¼š

```ts
// è¡¨å•åˆ›å»ºæ—¶æ³¨å†Œæ ¡éªŒå¼•æ“
const { app, form } = createForm({
  resolvers: {
    validator: {
      zod: zodResolver,      // Zod å¼•æ“
      yup: yupResolver,      // Yup å¼•æ“
      custom: customResolver // è‡ªå®šä¹‰å¼•æ“
    }
  }
})

// ä½¿ç”¨ä¸åŒå¼•æ“çš„æ ¡éªŒå™¨
defineField({
  id: "data",
  component: Input,
  validators: [
    defineValidator()
      .schema(z.string())
      .engine('zod'),
      
    defineValidator()
      .schema(yup.string())
      .engine('yup'),
      
    defineValidator()
      .schema({ required: true, minLength: 3 })
      .engine('custom')
  ]
})
```

## è‡ªå®šä¹‰æ ¡éªŒå™¨

### custom æ–¹æ³•

æä¾›å®Œå…¨è‡ªå®šä¹‰çš„æ ¡éªŒé€»è¾‘ï¼š

```ts
defineValidator()
  .updateOn(['onBlur'])
  .custom((ctx) => {
    const { value, query, execDecision, engine, updateOn } = ctx
    
    // è·å–å…¶ä»–å­—æ®µä¿¡æ¯
    const relatedField = query('relatedField')?.value
    
    // æ‰§è¡Œå†³ç­–é€»è¾‘
    const hasPermission = execDecision(D.use('validatePermission'))
    
    // è‡ªå®šä¹‰æ ¡éªŒé€»è¾‘
    if (!hasPermission) {
      return {
        message: "æ‚¨æ²¡æœ‰æƒé™ä¿®æ”¹æ­¤å­—æ®µ",
        type: "error"
      }
    }
    
    if (value && relatedField && value === relatedField) {
      return {
        message: "æ­¤å­—æ®µä¸èƒ½ä¸ç›¸å…³å­—æ®µç›¸åŒ",
        type: "warning"
      }
    }
  })
```

### å¼‚æ­¥è‡ªå®šä¹‰æ ¡éªŒ

```ts title="å¼‚æ­¥å”¯ä¸€æ€§æ£€æŸ¥"
defineValidator()
  .debounce(800)
  .custom(async (ctx, abortSignal) => {
    const { value } = ctx
    
    if (!value?.trim()) return
    
    // ç›‘å¬å–æ¶ˆä¿¡å·
    abortSignal?.addEventListener('abort', () => {
      console.log('å”¯ä¸€æ€§æ£€æŸ¥è¢«å–æ¶ˆ')
    })
    
    try {
      const isUnique = await checkUsernameUnique(value, { 
        signal: abortSignal 
      })
      
      if (abortSignal?.aborted) return
      
      if (!isUnique) {
        return {
          message: "ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·é€‰æ‹©å…¶ä»–ç”¨æˆ·å",
          type: "error"
        }
      }
    } catch (error) {
      if (error.name !== 'AbortError') {
        return {
          message: "æ£€æŸ¥ç”¨æˆ·åæ—¶å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•",
          type: "error"
        }
      }
    }
  })
```

### Context ç±»å‹å®šä¹‰

```ts
interface ValidatorContext<T = any> {
  value: T | ValueRef<T>           // å½“å‰å­—æ®µå€¼
  engine: string                   // æ ¡éªŒå¼•æ“åç§°
  execDecision: (decision: Decision) => boolean // å†³ç­–æ‰§è¡Œå™¨
  query: (id: string) => FieldHandler | undefined // å­—æ®µæŸ¥è¯¢å™¨
  updateOn?: string               // è§¦å‘äº‹ä»¶ç±»å‹
}
```

## é˜²æŠ–ä¸ç«æ€å¤„ç†

### debounce é…ç½®

å¤„ç†é¢‘ç¹æ ¡éªŒå’Œå¼‚æ­¥ç«æ€é—®é¢˜ï¼š

```ts
defineValidator()
  .debounce(1000, {
    edges: ['trailing'], // é»˜è®¤ä¸º ['trailing']
    signal: abortSignal  // å¯é€‰çš„å–æ¶ˆä¿¡å·
  })
  .updateOn(['onChange'])
  .custom(async (ctx, abortSignal) => {
    // ç›‘å¬å–æ¶ˆäº‹ä»¶
    abortSignal?.addEventListener('abort', () => {
      console.log('æ ¡éªŒè¢«ä¸­æ­¢')
    })
    
    return new Promise((resolve) => {
      setTimeout(() => {
        if (!abortSignal?.aborted) {
          resolve({
            message: "å¼‚æ­¥æ ¡éªŒå®Œæˆ",
            type: "info"
          })
        }
      }, 2000)
    })
  })
```

### edges é€‰é¡¹è¯´æ˜

```ts
// ä»…åœ¨å»¶è¿Ÿç»“æŸæ—¶æ‰§è¡Œï¼ˆé»˜è®¤ï¼‰
.debounce(500, { edges: ['trailing'] })

// ä»…åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ç«‹å³æ‰§è¡Œ
.debounce(500, { edges: ['leading'] })

// åœ¨å¼€å§‹å’Œç»“æŸæ—¶éƒ½æ‰§è¡Œï¼ˆéœ€è¦è‡³å°‘ä¸¤æ¬¡è°ƒç”¨ï¼‰
.debounce(500, { edges: ['leading', 'trailing'] })
```

## è¢«åŠ¨å¼æ ¡éªŒç‰¹æ€§

åœ¨è¢«åŠ¨å¼æ ¡éªŒä¸­ï¼Œä»¥ä¸‹èƒ½åŠ›ä¼šè‡ªåŠ¨å˜ä¸ºå“åº”å¼ï¼š

1. **fact å‡½æ•°è¿”å›å€¼**ï¼šè‡ªåŠ¨æ”¶é›†ä¾èµ–ï¼Œå“åº”å¼æ›´æ–°
2. **è‡ªå®šä¹‰æ ¡éªŒå™¨ä¸­çš„ value å’Œ query**ï¼šè‡ªåŠ¨è·Ÿè¸ªå˜åŒ–

```ts title="è¢«åŠ¨å¼æ ¡éªŒç¤ºä¾‹"
defineField({
  id: "confirmPassword",
  component: Input,
  validators: defineValidator()
    .passive() // è¢«åŠ¨å¼æ ¡éªŒ
    .fact((value, query) => ({
      password: query('password')?.value, // å“åº”å¼ä¾èµ–
      confirmPassword: value
    }))
    .custom((ctx) => {
      // ctx.value å’Œ query ç»“æœéƒ½æ˜¯å“åº”å¼çš„
      if (ctx.value.password !== ctx.value.confirmPassword) {
        return {
          message: "ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´",
          type: "error"
        }
      }
    })
})
```

## æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **åˆç†çš„æ ¡éªŒæ—¶æœº**
   ```ts
   // å®æ—¶åé¦ˆç”¨ onChangeï¼Œå®Œæ•´æ€§æ ¡éªŒç”¨ onBlur
   defineValidator()
     .updateOn(['onChange'])
     .type('warning') // å®æ—¶æç¤ºç”¨ warning
   
   defineValidator()  
     .updateOn(['onBlur'])
     .type('error') // ä¸¥æ ¼æ ¡éªŒç”¨ error
   ```

2. **é˜²æŠ–å¼‚æ­¥æ ¡éªŒ**
   ```ts
   defineValidator()
     .debounce(500) // é¿å…é¢‘ç¹è¯·æ±‚
     .custom(async (ctx, signal) => {
       // å¤„ç† AbortSignal
     })
   ```

3. **æ¸…æ™°çš„æ ¡éªŒå±‚çº§**
   ```ts
   validators: [
     // 1. å¿…å¡«æ ¡éªŒ
     defineValidator().schema(z.string()).type('error'),
     // 2. æ ¼å¼æ ¡éªŒ  
     defineValidator().schema(z.string().email()).type('warning'),
     // 3. ä¸šåŠ¡æ ¡éªŒ
     defineValidator().custom(businessValidation).type('info')
   ]
   ```

### âŒ é¿å…çš„åšæ³•

1. **è¿‡äºå¤æ‚çš„å•ä¸ªæ ¡éªŒå™¨**
2. **å¿½ç•¥å¼‚æ­¥æ ¡éªŒçš„å–æ¶ˆå¤„ç†**
3. **è¿‡åº¦ä½¿ç”¨ break(false)**

SignalForm çš„æ ¡éªŒå™¨ç³»ç»Ÿæä¾›äº†å®Œæ•´è€Œçµæ´»çš„è§£å†³æ–¹æ¡ˆï¼Œèƒ½å¤Ÿåº”å¯¹å„ç§å¤æ‚çš„è¡¨å•æ ¡éªŒåœºæ™¯ï¼âœ¨
